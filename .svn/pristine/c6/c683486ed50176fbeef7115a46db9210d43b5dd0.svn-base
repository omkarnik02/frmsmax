import pandas as pd
from flask import Flask, render_template, request, redirect, url_for
from datetime import datetime
import time

app = Flask(__name__)


class Rule:
    def __init__(self, channel,column, operator, value,allpre, created_by):
        self.column = column
        self.operator = operator
        self.channel = channel
        self.value = value
        self.allowprevent=allpre
        self.created_on = datetime.now()
        self.created_by = created_by
        self.modified_on = ''
        self.modified_by = ''
        self.id = int(time.time())
        self.status = 'Enabled'


class RuleManager:
    def __init__(self,user,df,del_df):
        self.user = user
        self.df = df
        self.deleted_df = del_df

    def create_rule(self, channel,column, operator, value,allpre, created_by):
        existing_rule = self.df[
            (self.df['column'] == column) & (self.df['operator'] == operator) & (self.df['value'] == value)]
        if not existing_rule.empty:
            return "Rule with the same column, operator, and value already exists"

        rule = Rule(channel,column, operator, value,allpre, self.user)
        rule_data = {
            'id': rule.id,
            'channel': rule.channel,
            'column': rule.column,
            'operator': rule.operator,
            'value': rule.value,
            'allowprevent': rule.allowprevent,
            'created_on': rule.created_on,
            'created_by': rule.created_by,
            'modified_on': '',
            'modified_by': '',
            'status': rule.status
        }
        self.df = pd.concat([self.df, pd.DataFrame([rule_data])], ignore_index=True)
        self.df.to_csv('app/rules.csv', index=False)

    def update_rule(self, rule_id,channel=None, column=None, operator=None, value=None, modified_by=None):
        if rule_id in self.df['id'].values:
            if channel:
                self.df.loc[self.df['id'] == rule_id, 'channel'] = channel
            if column:
                self.df.loc[self.df['id'] == rule_id, 'column'] = column
            if operator:
                self.df.loc[self.df['id'] == rule_id, 'operator'] = operator
            if value:
                self.df.loc[self.df['id'] == rule_id, 'value'] = value
            if modified_by:
                self.df.loc[self.df['id'] == rule_id, 'modified_by'] = modified_by

            self.df.loc[self.df['id'] == rule_id, 'modified_on'] = datetime.now()
            self.df.to_csv('app/rules.csv', index=False)

    def delete_rule(self, rule_id, deleted_by):
        if rule_id in self.df['id'].values:
            deleted_row = self.df[self.df['id'] == rule_id].copy()
            deleted_row['deleted_on'] = datetime.now()
            deleted_row['deleted_by'] = deleted_by
            self.deleted_df = pd.concat([self.deleted_df, deleted_row], ignore_index=True)
            self.df = self.df[self.df['id'] != rule_id]
            self.deleted_df.to_csv('app/delRules.csv', index=False)
            self.df.to_csv('app/rules.csv', index=False)

    def toggle_rule_status(self, rule_id):
        if rule_id in self.df['id'].values:
            current_status = self.df.loc[self.df['id'] == rule_id, 'status'].iloc[0]
            new_status = 'Enabled' if current_status == 'Disabled' else 'Disabled'
            self.df.loc[self.df['id'] == rule_id, 'status'] = new_status
            self.df.to_csv('app/rules.csv', index=False)
    def get_rules(self):
        # Return rules as a list of dictionaries
        return self.df.to_dict('records')